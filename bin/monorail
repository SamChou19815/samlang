#!/usr/bin/env node
module.exports=(()=>{"use strict";var e={242:(e,n,t)=>{t.r(n);var o=t(129);var r=t(747);var i=t(622);var c=t(605);var s=undefined&&undefined.__awaiter||function(e,n,t,o){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,n||[])).next())})};const d=e=>{const n=[];const t=[];e.trim().split("\n").forEach(e=>{const o=e.trim().split(/\s/).filter(e=>e.trim().length>0);if(o.length===0){return}const r=o[0];if(r==="A"||r==="M"){n.push(o[1])}else if(r==="D"){t.push(o[1])}else if(r.startsWith("R")){t.push(o[1]);n.push(o[2])}});return{changedFiles:n,deletedFiles:t}};const u=e=>new Promise((n,t)=>{c.get(e,e=>{let o="";e.on("data",e=>{o+=e});e.on("end",()=>{try{n(JSON.parse(o))}catch(e){t(e)}})}).on("error",e=>{t(e)})});const a=(e,n=".")=>s(void 0,void 0,void 0,function*(){const t=yield u(`http://localhost:19815/?since=${e}&pathPrefix=${n}`);const o=[];const r=[];t.forEach(({type:e,filename:n})=>{if(e==="changed"){o.push(n)}else{r.push(n)}});return{changedFiles:o,deletedFiles:r}});const l=(e,n=".")=>s(void 0,void 0,void 0,function*(){const t=(e,t)=>{const r=(0,o.spawnSync)("git",["diff",e,...t?[t]:[],"--name-status","--diff-filter=ADRM","--",n]).stdout.toString();return d(r)};if(process.env.CI){return t("HEAD^","HEAD")}try{return yield a(e,n)}catch(e){return t("origin/master")}});const f=l;var p=undefined&&undefined.__awaiter||function(e,n,t,o){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,n||[])).next())})};const v=e=>p(void 0,void 0,void 0,function*(){const n=(0,r.existsSync)(e.lastestKnownGoodRunTimeFilename)?JSON.parse((0,r.readFileSync)(e.lastestKnownGoodRunTimeFilename).toString()):{};const t=yield e.needRerun(n);const o=yield Promise.all(t.map(t=>p(void 0,void 0,void 0,function*(){return[t,yield e.rerun(t,n)]})));const c=(new Date).getTime();const s=[];o.forEach(([e,t])=>{if(t){n[e]=c}else{s.push(e)}});(0,r.mkdirSync)((0,i.dirname)(e.lastestKnownGoodRunTimeFilename),{recursive:true});(0,r.writeFileSync)(e.lastestKnownGoodRunTimeFilename,JSON.stringify(n,undefined,2));return s});const y=v;var h=undefined&&undefined.__awaiter||function(e,n,t,o){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,n||[])).next())})};const w=e=>JSON.parse((0,r.readFileSync)(e).toString());const m=(e,n,t)=>h(void 0,void 0,void 0,function*(){const o=t=>(0,i.dirname)(t)!==(0,i.join)(e.information[n].workspaceLocation,"bin");const r=yield Promise.all(e.information[n].dependencyChain.map(n=>h(void 0,void 0,void 0,function*(){var r;const{changedFiles:i,deletedFiles:c}=yield f((r=t[n])!==null&&r!==void 0?r:0,e.information[n].workspaceLocation);return i.some(o)||c.some(o)})));return r.some(e=>e)});const _=(e,n,t)=>h(void 0,void 0,void 0,function*(){const o=yield Promise.all(e.topologicallyOrdered.map(o=>h(void 0,void 0,void 0,function*(){if(!t(e,o)){return[o,false]}const r=yield m(e,o,n);return[o,r]})));return o.filter(([,e])=>e).map(([e])=>e)});const g=(e,n)=>h(void 0,void 0,void 0,function*(){const t=w("workspaces.json");const r=yield y({lastestKnownGoodRunTimeFilename:(0,i.join)(".monorail",`${e}-cache.json`),needRerun:o=>h(void 0,void 0,void 0,function*(){const r=yield _(t,o,n);if(r.length!==0){console.log(`[${r.join(", ")}] needs to be ${e}d!`)}return r}),rerun:n=>h(void 0,void 0,void 0,function*(){console.log(`Running \`yarn workspace ${n} ${e}\`...`);const t=(0,o.spawn)("yarn",["workspace",n,e]);return yield new Promise(e=>{t.on("exit",n=>e(n===0))})})});if(r.length===0){console.log(`[âœ“] All workspaces have been successfully ${e}d!`);return}throw new Error(`[x] [${r.join(", ")}] failed to exit with 0`)});const x=()=>h(void 0,void 0,void 0,function*(){return g("compile",()=>true)});const S=()=>h(void 0,void 0,void 0,function*(){return g("bundle",(e,n)=>{var t;const o=w((0,i.join)(e.information[n].workspaceLocation,"package.json"));return((t=o===null||o===void 0?void 0:o.scripts)===null||t===void 0?void 0:t.bundle)!=null})});const j=()=>{let e=process.cwd();while(e!=="/"){const n=(0,i.join)(e,"package.json");if((0,r.existsSync)(n)&&(0,r.lstatSync)(n).isFile()){const t=JSON.parse((0,r.readFileSync)(n).toString());if(Array.isArray(t.workspaces)){return e}}e=(0,i.dirname)(e)}throw new Error("No root package.json found. Abort!")};const b=()=>{try{process.chdir(j())}catch(e){console.error(e.message);process.exit(1)}};var k=undefined&&undefined.__awaiter||function(e,n,t,o){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,n||[])).next())})};const P=()=>k(void 0,void 0,void 0,function*(){try{b();switch(process.argv[2].toLowerCase()){case"compile":case"c":yield x();return;case"bundle":case"b":yield S();return;default:throw new Error}}catch(e){console.error(e);process.exit(1)}});P()},129:e=>{e.exports=require("child_process")},747:e=>{e.exports=require("fs")},605:e=>{e.exports=require("http")},622:e=>{e.exports=require("path")}};var n={};function __webpack_require__(t){if(n[t]){return n[t].exports}var o=n[t]={exports:{}};var r=true;try{e[t](o,o.exports,__webpack_require__);r=false}finally{if(r)delete n[t]}return o.exports}(()=>{__webpack_require__.r=(e=>{if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(e,"__esModule",{value:true})})})();__webpack_require__.ab=__dirname+"/";return __webpack_require__(242)})();