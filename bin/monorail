#!/usr/bin/env node
module.exports=(()=>{"use strict";var e={242:(e,n,t)=>{t.r(n);var o=t(129);var i=t(747);var r=t(622);var c=t(605);var s=undefined&&undefined.__awaiter||function(e,n,t,o){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,i){function fulfilled(e){try{step(o.next(e))}catch(e){i(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){i(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,n||[])).next())})};const d=e=>{const n=[];const t=[];e.trim().split("\n").forEach(e=>{const o=e.trim().split(/\s/).filter(e=>e.trim().length>0);if(o.length===0){return}const i=o[0];if(i==="A"||i==="M"){n.push(o[1])}else if(i==="D"){t.push(o[1])}else if(i.startsWith("R")){t.push(o[1]);n.push(o[2])}});return{changedFiles:n,deletedFiles:t}};const u=e=>new Promise((n,t)=>{c.get(e,e=>{let o="";e.on("data",e=>{o+=e});e.on("end",()=>{try{n(JSON.parse(o))}catch(e){t(e)}})}).on("error",e=>{t(e)})});const a=(e,n=".")=>s(void 0,void 0,void 0,function*(){const t=yield u(`http://localhost:19815/?since=${e}&pathPrefix=${n}`);const o=[];const i=[];t.forEach(({type:e,filename:n})=>{if(e==="changed"){o.push(n)}else{i.push(n)}});return{changedFiles:o,deletedFiles:i}});const l=(e,n=".")=>s(void 0,void 0,void 0,function*(){const t=(e,t)=>{const i=(0,o.spawnSync)("git",["diff",e,...t?[t]:[],"--name-status","--diff-filter=ADRM","--",n]).stdout.toString();return d(i)};if(process.env.CI){return t("HEAD^","HEAD")}try{return yield a(e,n)}catch(e){return t("origin/master")}});const f=l;var p=undefined&&undefined.__awaiter||function(e,n,t,o){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,i){function fulfilled(e){try{step(o.next(e))}catch(e){i(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){i(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,n||[])).next())})};const v=e=>p(void 0,void 0,void 0,function*(){const n=(0,i.existsSync)(e.lastestKnownGoodRunTimeFilename)?JSON.parse((0,i.readFileSync)(e.lastestKnownGoodRunTimeFilename).toString()):{};const t=yield e.needRerun(n);const o=yield Promise.all(t.map(t=>p(void 0,void 0,void 0,function*(){return[t,yield e.rerun(t,n)]})));const c=(new Date).getTime();const s=[];o.forEach(([e,t])=>{if(t){n[e]=c}else{s.push(e)}});(0,i.mkdirSync)((0,r.dirname)(e.lastestKnownGoodRunTimeFilename),{recursive:true});(0,i.writeFileSync)(e.lastestKnownGoodRunTimeFilename,JSON.stringify(n,undefined,2));return s});const y=v;var h=undefined&&undefined.__awaiter||function(e,n,t,o){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,i){function fulfilled(e){try{step(o.next(e))}catch(e){i(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){i(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,n||[])).next())})};const w=e=>JSON.parse((0,i.readFileSync)(e).toString());const m=(e,n,t)=>h(void 0,void 0,void 0,function*(){const o=t=>(0,r.dirname)(t)!==(0,r.join)(e.information[n].workspaceLocation,"bin");const i=yield Promise.all(e.information[n].dependencyChain.map(n=>h(void 0,void 0,void 0,function*(){var i;const{changedFiles:r,deletedFiles:c}=yield f((i=t[n])!==null&&i!==void 0?i:0,e.information[n].workspaceLocation);return r.some(o)||c.some(o)})));return i.some(e=>e)});const _=(e,n,t,o)=>h(void 0,void 0,void 0,function*(){const i=yield Promise.all(e.topologicallyOrdered.map(i=>h(void 0,void 0,void 0,function*(){if(!o(e,i)){return[i,false]}if(t(e,i)){return[i,true]}const r=yield m(e,i,n);return[i,r]})));return i.filter(([,e])=>e).map(([e])=>e)});const g=(e,n,t)=>h(void 0,void 0,void 0,function*(){const i=w("workspaces.json");const c=yield y({lastestKnownGoodRunTimeFilename:(0,r.join)(".monorail",`${e}-cache.json`),needRerun:o=>h(void 0,void 0,void 0,function*(){const r=yield _(i,o,n,t);if(r.length!==0){console.log(`[${r.join(", ")}] needs to be ${e}d!`)}return r}),rerun:n=>h(void 0,void 0,void 0,function*(){console.log(`Running \`yarn workspace ${n} ${e}\`...`);const t=(0,o.spawn)("yarn",["workspace",n,e]);return yield new Promise(e=>{t.on("exit",n=>e(n===0))})})});if(c.length===0){console.log(`[âœ“] All workspaces have been successfully ${e}d!`);return}throw new Error(`[x] [${c.join(", ")}] failed to exit with 0`)});const x=()=>h(void 0,void 0,void 0,function*(){return g("compile",()=>false,()=>true)});const S=()=>h(void 0,void 0,void 0,function*(){return g("bundle",(e,n)=>!(0,i.existsSync)((0,r.join)(e.information[n].workspaceLocation,"bin","index.js")),(e,n)=>{var t;const o=w((0,r.join)(e.information[n].workspaceLocation,"package.json"));return((t=o===null||o===void 0?void 0:o.scripts)===null||t===void 0?void 0:t.bundle)!=null})});const j=()=>{let e=process.cwd();while(e!=="/"){const n=(0,r.join)(e,"package.json");if((0,i.existsSync)(n)&&(0,i.lstatSync)(n).isFile()){const t=JSON.parse((0,i.readFileSync)(n).toString());if(Array.isArray(t.workspaces)){return e}}e=(0,r.dirname)(e)}throw new Error("No root package.json found. Abort!")};const b=()=>{try{process.chdir(j())}catch(e){console.error(e.message);process.exit(1)}};var k=undefined&&undefined.__awaiter||function(e,n,t,o){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,i){function fulfilled(e){try{step(o.next(e))}catch(e){i(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){i(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,n||[])).next())})};const P=()=>k(void 0,void 0,void 0,function*(){try{b();switch(process.argv[2].toLowerCase()){case"compile":case"c":yield x();return;case"bundle":case"b":yield S();return;default:throw new Error}}catch(e){console.error(e);process.exit(1)}});P()},129:e=>{e.exports=require("child_process")},747:e=>{e.exports=require("fs")},605:e=>{e.exports=require("http")},622:e=>{e.exports=require("path")}};var n={};function __webpack_require__(t){if(n[t]){return n[t].exports}var o=n[t]={exports:{}};var i=true;try{e[t](o,o.exports,__webpack_require__);i=false}finally{if(i)delete n[t]}return o.exports}(()=>{__webpack_require__.r=(e=>{if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(e,"__esModule",{value:true})})})();__webpack_require__.ab=__dirname+"/";return __webpack_require__(242)})();